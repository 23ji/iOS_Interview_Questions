#  17. iOS 앱에서 Multi-threading을 구현하는 방법은 무엇인가요?

# ✅ iOS 멀티스레딩(Multi-threading) 개념부터 이해하기

## 📌 멀티스레딩이 필요한 이유

앱은 보통 **여러 일을 동시에 해야 함**

예:

* 서버에서 이미지 다운로드
* JSON 파싱
* 위치 정보 가져오기
* 유저는 앱 UI를 계속 만짐

만약 한 스레드(메인스레드)에서만 이 모든 일을 하면?

❌ 앱 멈춤(프리징)
❌ 버튼 눌러도 반응 없음
❌ 스크롤 버벅임

그래서 iOS는 **백그라운드 스레드에서 무거운 일 처리 → 메인 스레드에서 UI 업데이트** 구조를 씀

이걸 쉽게 해주는 도구가
👉 **DispatchQueue(GCD)**
👉 **OperationQueue**

---

# 1️⃣ DispatchQueue(GCD) — iOS 멀티스레딩의 기본

## ⭐ 개념

* 작업을 **큐(Queue)**에 넣으면 알아서 스레드가 가져가서 실행함
* 클로저 기반
* 사용법 간단함
* 성능 아주 좋음(시스템 레벨)

## ⭐ 큐 종류

### ① 메인 큐 (Main Queue)

* UI 관련 모든 일은 여기서
* 버튼 클릭, 화면 그리기 등

```swift
DispatchQueue.main.async {
    self.label.text = "완료됨"
}
```

### ② 글로벌 큐(Global Queue)

* 백그라운드 작업용
* 무거운 연산/네트워크 작업

```swift
DispatchQueue.global().async {
    let data = heavyWork()
}
```

### ➕ 큐 성격

* **Serial Queue**: 한 번에 1개씩
* **Concurrent Queue**: 여러 작업 동시에

---

# 2️⃣ OperationQueue — 더 정교하게 작업 제어 가능

## ⭐ 개념

DispatchQueue보다 레벨이 높은 추상화
작업을 `Operation`이라는 객체로 다룸

## ⭐ 특징

* 작업 취소 가능(cancel)
* 작업 사이 의존성 설정 가능
* 상태(state) 추적 가능 (isFinished, isExecuting)
* 순서 지정 가능

예:
“이미지 다운로드 → 필터 적용 → 저장”
이 순서를 강제해야 할 때 좋음

```swift
let queue = OperationQueue()

let download = DownloadOperation()
let filter = FilterOperation()
let save = SaveOperation()

filter.addDependency(download)
save.addDependency(filter)

queue.addOperations([download, filter, save], waitUntilFinished: false)
```

---

# 3️⃣ 동시성 문제: Race Condition 완전 개념정리

## ⭐ Race Condition이란?

두 스레드가 **같은 데이터**를 동시에 수정해서 꼬이는 상황

예:
은행 앱에서

* A 스레드: 잔액 읽고 5만원 출금
* B 스레드: 잔액 읽고 10만원 출금

잔액이 꼬일 수 있음

→ “누가 먼저 수정했는가?” 타이밍에 따라 결과가 달라짐
→ **버그 발생**

## ⭐ 해결 방법 4가지

### ① Serial Queue

작업을 한 줄로 세움 → 동시에 접근 불가

### ② Lock

데이터를 사용할 때 문 잠금 → 다른 스레드 대기

```swift
lock.lock()
balance -= 50000
lock.unlock()
```

### ③ Dispatch Barrier

Concurrent Queue에서도 특정 순간에는 한 스레드만 실행하도록 막는 기능

### ④ Thread-Safe 자료구조 사용

Apple이 만들어놓은 안전한 구조 쓰는 것

---

# 4️⃣ 왜 UI는 메인 스레드에서만?

iOS는 UI 변경 작업이 다른 스레드에서 일어나면 **충돌 위험** 있음

* UI 그리는 엔진이 메인 스레드 기반
* 여러 스레드에서 동시에 UI 건들면 앱 터짐

그래서 백그라운드 작업 후 UI 변경은 항상 이렇게 해야 함:

```swift
DispatchQueue.main.async {
    self.tableView.reloadData()
}
```

---

# 🔥 핵심 개념 요약 (처음 공부용 + 평생 기억용)

### 💡 멀티스레딩 사용 이유

앱 렉 없이
백그라운드 일 + UI 작업 분리하려고

---

### 💡 DispatchQueue(GCD)

* 간단
* 빠름
* 백그라운드/메인 제어 쉬움
  → 대부분 기능 구현에서 가장 많이 씀

---

### 💡 OperationQueue

* 취소/일시정지 가능
* 작업 간 순서 지정 가능
* 복잡한 작업 제어할 때 유리

---

### 💡 Race Condition

두 스레드가 동시에 같은 변수 건드리면 꼬이는 현상
→ Serial Queue / Lock / Barrier로 해결

---

### 💡 UI는 메인 스레드에서만

* iOS UI 엔진이 메인 스레드 기반
* 백그라운드에서 UI 만지면 크래시
